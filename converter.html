<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forti Converter Pro | Infralix</title>
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAADHElEQVR4nO2WX0hTYRjGn3PO2bZtbtM5Z5rmJc1LmpeYmZUXFM0uRpdCG1mY2cXohxdFUEQUlBd9KIIioqAkKAvLKLtYmKWZSZmXvJSXvOY1b2fbtm7vLrQD5mDbnLPTh/rBB8/7fu/zPO/7vu97gH8Z/zIURcHhcKDRaKBQKP4JhUIBjUYDh8MBiqKIAhRFQSKRQCqVQiKR+F8oFBJIpVJQFEUIoCgKEokEYrEYIpHorxGJRBCLxZBIJCQAlmUhEokgFAohEAj8JwQCAYRCIViWJQGwLAuBQAAejwcej0dK4HA44PF4EAgEJACWZcHj8cDj8cDlckkLXC4XXC4XLMuSALhcLmiaBlEUwefzSQl8Ph9EUQRFUSQAiqJA0zRomiYs8Hg8EAQBmqZJADRNg6Zp8Hg88Hg8UgKPxwNBEEDTNAmApmkQxH8r8DFCUZRfmY8R/gSgaRp/ZJl3AoGAoigIhUIQCoUQCoUk9VIU9T8BLMtCJBJBKBRCJBKRpB6Kov4nAMuy/lsgJiYGcXFxiI+PR3x8POLi4lYVHx+fFhERkRYZGZkWGRmZFhYWlhYWFpYaHh6eGhYWlhoeHp4aFhamFwqFepFIpBcKhXqhUKgXCARpHA4nDUAmk+H58+d4/vw57t+/j8XFxVU1Njaisb ERra2taGhowPz8PObm5jA3N4fGxkZf+vr6elRVVaGyshKVlZW+8rq6OlRXV6O6uhpVVVW+9A0NDWhoaEBDQwPq6+t96evr61FbW4va2lrU1NT40tfW1vrSV1dX+9JXV1ejsrISFRUVqKioWFVMTExlZWVl/G/Q0NCAyspK/jeoqalBZWUl/xtUV1ejoqJiRcXFxSguLkZBQQEKCgpQUFCAgoICFBQUIDs7G9nZ2cjJyUFOTg4yMzORmZmJjIwMZGRkIC0tDWlpaUhNTUVqaipSUlKQkpKC5ORkJCcnIykpCUlJSUhMTERiYiLi4+MRHx+P2NhYxMbGIiYmBtHR0YiOjkZUVBSioqIQGRmJyMhIREZGwm63W6xWq9lqtZqsVqvBYrEYrFar2Wq1mq1Wq9lqtVoMer0+VafTRf4rDA0NwWq1qiorK6U+pxpoNBrIZDLIZDLIZDJIpdL5ycnJfbFotL9Op9PzeDw9n8/X5+fn6/Py8vS5ubn63Nxc/czMzNaZmZmtU1NTWycnJ7dOTExsnZiY2D4xMbFjYmJix/j4+A4AeQDyVvhf8QPhPvPYTB2MowAAAABJRU5ErkJggg==">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --infralix-orange: #f1572b;
            --dark-bg: #0a0a0b;
            --darker-bg: #050506;
            --card-bg: #131316;
            --border-color: #242428;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a8;
            --text-muted: #606068;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
        }
        body { font-family: 'Outfit', sans-serif; background: var(--dark-bg); color: var(--text-primary); line-height: 1.6; }
        .app-container { min-height: 100vh; position: relative; }
        .bg-gradient { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 20% 50%, rgba(241, 87, 43, 0.08) 0%, transparent 50%), radial-gradient(circle at 80% 80%, rgba(241, 87, 43, 0.06) 0%, transparent 50%); z-index: 0; animation: gradientShift 20s ease infinite; }
        @keyframes gradientShift { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        .header { position: relative; z-index: 10; padding: 2rem 3rem; border-bottom: 1px solid var(--border-color); backdrop-filter: blur(10px); background: rgba(10, 10, 11, 0.8); }
        .header-content { max-width: 1800px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo-section { display: flex; align-items: center; gap: 1.5rem; }
        .logo-svg { height: 40px; width: auto; }
        .divider { width: 1px; height: 40px; background: var(--border-color); }
        .tool-name { font-size: 1.3rem; font-weight: 600; font-family: 'JetBrains Mono', monospace; }
        .pro-badge { padding: 0.3rem 0.8rem; background: linear-gradient(135deg, var(--infralix-orange), #ff7849); border-radius: 6px; color: white; font-size: 0.75rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .main-content { position: relative; z-index: 1; max-width: 1800px; margin: 0 auto; padding: 3rem; }
        .step-indicator { display: flex; justify-content: center; gap: 2rem; margin-bottom: 4rem; }
        .step { display: flex; flex-direction: column; align-items: center; gap: 0.8rem; }
        .step-number { width: 50px; height: 50px; border-radius: 50%; background: var(--card-bg); border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.2rem; font-family: 'JetBrains Mono', monospace; transition: all 0.3s ease; }
        .step.active .step-number { background: var(--infralix-orange); border-color: var(--infralix-orange); box-shadow: 0 0 30px rgba(241, 87, 43, 0.5); }
        .step.completed .step-number { background: var(--success); border-color: var(--success); }
        .step-label { font-size: 0.9rem; color: var(--text-muted); font-weight: 500; text-align: center; }
        .step.active .step-label { color: var(--infralix-orange); font-weight: 600; }
        .card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 16px; padding: 2.5rem; margin-bottom: 2rem; transition: all 0.3s ease; }
        .card:hover { border-color: rgba(241, 87, 43, 0.3); }
        .card-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; }
        .card-description { color: var(--text-secondary); margin-bottom: 2rem; font-size: 0.95rem; }
        .alert { padding: 1rem 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; border: 1px solid; display: flex; gap: 1rem; }
        .alert-info { background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3); color: var(--info); }
        .alert-warning { background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.3); color: var(--warning); }
        .alert-success { background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.3); color: var(--success); }
        .alert-error { background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: var(--error); }
        .file-upload-area { border: 2px dashed var(--border-color); border-radius: 12px; padding: 3rem; text-align: center; cursor: pointer; background: var(--darker-bg); transition: all 0.3s ease; }
        .file-upload-area:hover { border-color: var(--infralix-orange); background: rgba(241, 87, 43, 0.05); }
        .file-upload-area.dragging { border-color: var(--infralix-orange); background: rgba(241, 87, 43, 0.1); transform: scale(1.02); }
        .upload-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; transition: all 0.3s ease; }
        .file-upload-area.dragging .upload-icon { opacity: 1; transform: scale(1.1); }
        .upload-text { color: var(--text-secondary); margin-bottom: 0.5rem; }
        .upload-hint { color: var(--text-muted); font-size: 0.85rem; }
        .file-info { display: flex; align-items: center; gap: 1rem; padding: 1.5rem; background: var(--darker-bg); border: 1px solid var(--success); border-radius: 10px; margin-top: 1rem; }
        .file-detected-badge { display: inline-flex; gap: 0.5rem; padding: 0.5rem 1rem; background: linear-gradient(135deg, var(--infralix-orange), #ff7849); border-radius: 6px; color: white; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .file-name { font-family: 'JetBrains Mono', monospace; color: var(--success); flex: 1; }
        .file-size { color: var(--text-muted); font-size: 0.85rem; }
        .select-wrapper { position: relative; }
        select { width: 100%; padding: 1rem 1.2rem; background: var(--darker-bg); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; cursor: pointer; appearance: none; }
        .select-wrapper::after { content: '‚ñº'; position: absolute; right: 1.2rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); pointer-events: none; }
        .mapping-table { width: 100%; border-collapse: collapse; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; }
        .mapping-table thead { background: var(--darker-bg); }
        .mapping-table th { padding: 1rem; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 2px solid var(--border-color); }
        .mapping-table td { padding: 1rem; border-bottom: 1px solid var(--border-color); }
        .mapping-table tbody tr:hover { background: rgba(241, 87, 43, 0.05); }
        .port-badge { padding: 0.4rem 0.8rem; background: rgba(241, 87, 43, 0.1); border: 1px solid rgba(241, 87, 43, 0.3); border-radius: 6px; color: var(--infralix-orange); font-weight: 600; }
        .usage-badge { padding: 0.3rem 0.6rem; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 4px; color: var(--success); font-size: 0.75rem; }
        .btn { padding: 1rem 2rem; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 0.8rem; font-family: 'Outfit', sans-serif; transition: all 0.3s ease; }
        .btn-primary { background: var(--infralix-orange); color: white; box-shadow: 0 4px 20px rgba(241, 87, 43, 0.3); }
        .btn-primary:hover:not(:disabled) { background: #ff7849; transform: translateY(-2px); }
        .btn-secondary { background: transparent; color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .button-group { display: flex; gap: 1rem; margin-top: 2rem; flex-wrap: wrap; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: var(--darker-bg); padding: 1.5rem; border-radius: 10px; border: 1px solid var(--border-color); }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--infralix-orange); font-family: 'JetBrains Mono', monospace; }
        .stat-label { color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.5rem; }
        .config-preview { background: var(--darker-bg); border: 1px solid var(--border-color); border-radius: 10px; padding: 2rem; max-height: 500px; overflow-y: auto; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; line-height: 1.8; }
        .config-line { margin-bottom: 0.3rem; }
        .config-line.changed { background: rgba(241, 87, 43, 0.1); border-left: 3px solid var(--infralix-orange); padding-left: 1rem; margin-left: -1rem; }
        .tab-container { display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 1px solid var(--border-color); }
        .tab { padding: 1rem 1.5rem; background: transparent; border: none; color: var(--text-secondary); font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab.active { color: var(--infralix-orange); border-bottom-color: var(--infralix-orange); }
        .unused-objects-section { margin-top: 2rem; padding: 1.5rem; background: rgba(245, 158, 11, 0.05); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 10px; }
        .unused-list { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem; }
        .unused-item { padding: 0.4rem 0.8rem; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--warning); }
        .version-compat-section { margin-top: 2rem; padding: 1.5rem; background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 10px; }
        .upgrade-path { margin-top: 1rem; padding: 1rem; background: var(--darker-bg); border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; }
        .utf8-issues-section { margin-top: 2rem; padding: 1.5rem; background: rgba(239, 68, 68, 0.05); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 10px; }
        .object-rename-table { width: 100%; margin-top: 1rem; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; }
        .object-rename-table th { padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        .object-rename-table td { padding: 0.5rem; border-bottom: 1px solid var(--border-color); }
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: var(--darker-bg); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 5px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState } = React;

        const FORTIGATE_MODELS = {
            '100D': { ports: ['port1','port2','port3','port4','port5','port6','port7','port8','port9','port10'], defaultHeader: '#config-version=FGT100D-5.6.6-FW-build1723:opmode=0:vdom=0:user=admin', maxVersion: '7.0.x', recommendedVersion: '7.0.17' },
            '200D': { ports: ['port1','port2','port3','port4','port5','port6','port7','port8','port9','port10'], defaultHeader: '#config-version=FGT200D-5.6.6-FW-build1723:opmode=0:vdom=0:user=admin', maxVersion: '7.0.x', recommendedVersion: '7.0.17' },
            '600D': { ports: Array.from({length: 14}, (_, i) => `port${i + 1}`), defaultHeader: '#config-version=FGT600D-5.6.6-FW-build1723:opmode=0:vdom=0:user=admin', maxVersion: '7.0.x', recommendedVersion: '7.0.17' },
            '1200D': { ports: Array.from({length: 32}, (_, i) => `port${i + 1}`), defaultHeader: '#config-version=FGT1200D-5.6.6-FW-build1723:opmode=0:vdom=0:user=admin', maxVersion: '7.0.x', recommendedVersion: '7.0.17', notes: 'Not supported on 7.2+' },
            '100E': { ports: ['port1','port2','port3','port4','port5','port6','port7','port8','port9','port10','dmz','wan1','wan2'], defaultHeader: '#config-version=FGT100E-6.2.7-FW-build1190:opmode=0:vdom=0:user=admin', maxVersion: '7.4.x', recommendedVersion: '7.4.7' },
            '60F': { ports: ['wan1','wan2','dmz','port1','port2','port3','port4','port5','port6','port7','port8','port9','port10'], defaultHeader: '#config-version=FGT60F-7.0.0-FW-build0157:opmode=0:vdom=0:user=admin', maxVersion: '7.6.x', recommendedVersion: '7.4.7' },
            '100F': { ports: ['wan1','wan2','dmz',...Array.from({length: 16}, (_, i) => `port${i + 1}`)], defaultHeader: '#config-version=FGT100F-7.0.0-FW-build0157:opmode=0:vdom=0:user=admin', maxVersion: '7.6.x', recommendedVersion: '7.4.7' },
            '200F': { ports: ['wan1','wan2','dmz',...Array.from({length: 16}, (_, i) => `port${i + 1}`)], defaultHeader: '#config-version=FGT200F-7.0.0-FW-build0157:opmode=0:vdom=0:user=admin', maxVersion: '7.6.x', recommendedVersion: '7.4.7' },
            '400F': { ports: Array.from({length: 20}, (_, i) => `port${i + 1}`), defaultHeader: '#config-version=FGT400F-7.0.0-FW-build0157:opmode=0:vdom=0:user=admin', maxVersion: '7.6.x', recommendedVersion: '7.4.7' },
            '800F': { ports: Array.from({length: 24}, (_, i) => `port${i + 1}`), defaultHeader: '#config-version=FGT800F-7.0.0-FW-build0157:opmode=0:vdom=0:user=admin', maxVersion: '7.6.x', recommendedVersion: '7.4.7' },
            '1800F': { ports: Array.from({length: 32}, (_, i) => `port${i + 1}`), defaultHeader: '#config-version=FGT1800F-7.0.0-FW-build0157:opmode=0:vdom=0:user=admin', maxVersion: '7.6.x', recommendedVersion: '7.4.7' },
            '3000F': { ports: Array.from({length: 48}, (_, i) => `port${i + 1}`), defaultHeader: '#config-version=FGT3000F-7.0.0-FW-build0157:opmode=0:vdom=0:user=admin', maxVersion: '7.6.x', recommendedVersion: '7.4.7' },
        };

        function detectConfigType(text) {
            if (text.includes('#config-version=') || text.includes('config system')) {
                const match = text.match(/#config-version=([A-Z]+\d+[A-Z]*)-(\d+\.\d+\.\d+)/i);
                const model = match ? match[1].replace('FGT', '').replace('FG', '') : null;
                const version = match ? match[2] : null;
                return { vendor: 'FortiGate', model, version, detected: true };
            }
            return { vendor: null, detected: false };
        }

        function validateUTF8Objects(parsed) {
            const issues = [];
            const allObjects = [...parsed.addressObjects, ...parsed.serviceObjects, ...parsed.addressGroups, ...parsed.serviceGroups];
            
            allObjects.forEach(obj => {
                // Check for non-ASCII characters
                if (!/^[\x00-\x7F]*$/.test(obj)) {
                    // Suggest sanitized name
                    const sanitized = obj
                        .normalize('NFD')
                        .replace(/[\u0300-\u036f]/g, '') // Remove diacritics
                        .replace(/[^\x00-\x7F]/g, '_')   // Replace non-ASCII with underscore
                        .replace(/\s+/g, '_')             // Replace spaces
                        .replace(/[^a-zA-Z0-9_-]/g, '')   // Remove special chars
                        .substring(0, 35);                // FortiGate max 35 chars
                    
                    if (sanitized !== obj) {
                        issues.push({
                            original: obj,
                            suggested: sanitized || 'obj_' + Date.now(),
                            issue: 'Non-UTF8 or special characters'
                        });
                    }
                }
            });
            
            return issues;
        }

        function getUpgradePath(sourceVersion, targetVersion) {
            if (!sourceVersion || !targetVersion) return null;
            
            const src = parseFloat(sourceVersion);
            const tgt = parseFloat(targetVersion);
            
            // Example upgrade paths based on Fortinet documentation
            const paths = {
                '5.6-7.0': ['5.6.x', '6.0.x', '6.2.x', '6.4.x', '7.0.x'],
                '6.0-7.0': ['6.0.x', '6.2.x', '6.4.x', '7.0.x'],
                '6.2-7.0': ['6.2.x', '6.4.x', '7.0.x'],
                '6.4-7.0': ['6.4.x', '7.0.x'],
                '7.0-7.2': ['7.0.x', '7.0.14', '7.2.x'],
                '7.0-7.4': ['7.0.x', '7.0.14', '7.2.x', '7.4.x'],
            };
            
            // Determine path key
            const srcMajor = Math.floor(src * 10) / 10;
            const tgtMajor = Math.floor(tgt * 10) / 10;
            const pathKey = `${srcMajor}-${tgtMajor}`;
            
            return paths[pathKey] || null;
        }

        function checkVersionCompatibility(sourceModel, sourceVersion, targetModel) {
            if (!sourceModel || !targetModel || !FORTIGATE_MODELS[targetModel]) return null;
            
            const targetInfo = FORTIGATE_MODELS[targetModel];
            const sourceInfo = FORTIGATE_MODELS[sourceModel];
            
            if (!sourceInfo) return { compatible: false, message: 'Source model not in database' };
            
            const compatibility = {
                canDowngrade: false,
                recommendDowngrade: false,
                upgradePath: null,
                warnings: []
            };
            
            // Check if source version is supported on target
            const srcVer = sourceVersion ? parseFloat(sourceVersion) : null;
            const tgtMax = targetInfo.maxVersion ? parseFloat(targetInfo.maxVersion) : 9.9;
            
            if (srcVer && srcVer <= tgtMax) {
                compatibility.canDowngrade = true;
                compatibility.message = `Target ${targetModel} supports FortiOS ${sourceVersion}`;
            } else if (srcVer && srcVer > tgtMax) {
                compatibility.canDowngrade = false;
                compatibility.message = `‚ö†Ô∏è Source version ${sourceVersion} NOT supported on ${targetModel}. Max: ${targetInfo.maxVersion}`;
                compatibility.recommendDowngrade = true;
                compatibility.warnings.push(`Downgrade source to ${targetInfo.maxVersion} before migration`);
            }
            
            // Get upgrade path
            if (sourceVersion && targetInfo.recommendedVersion) {
                compatibility.upgradePath = getUpgradePath(sourceVersion, targetInfo.recommendedVersion);
            }
            
            return compatibility;
        }

        function parseConfig(text) {
            const ports = new Set();
            const portUsage = {};
            const addresses = new Set();
            const services = new Set();
            const addrgrps = new Set();
            const svcgrps = new Set();
            let section = null;

            text.split('\n').forEach(line => {
                const t = line.trim();
                if (t.startsWith('config firewall address')) section = 'addr';
                else if (t.startsWith('config firewall addrgrp')) section = 'addrgrp';
                else if (t.startsWith('config firewall service')) section = 'svc';
                else if (t === 'end') section = null;
                
                if (t.startsWith('edit ')) {
                    const obj = t.match(/edit ["']?([^"']+)["']?/)?.[1];
                    if (section === 'addr' && obj) addresses.add(obj);
                    if (section === 'addrgrp' && obj) addrgrps.add(obj);
                    if (section === 'svc' && obj) services.add(obj);
                }
                
                const patterns = [
                    /set interface ["']?([a-zA-Z0-9_-]+)["']?/g,
                    /set member ["']?([a-zA-Z0-9_-]+)["']?/g,
                    /set srcintf ["']?([a-zA-Z0-9_-]+)["']?/g,
                    /set dstintf ["']?([a-zA-Z0-9_-]+)["']?/g,
                ];
                
                patterns.forEach(p => {
                    [...t.matchAll(p)].forEach(m => {
                        const port = m[1];
                        if (port && (port.startsWith('port') || port.startsWith('wan') || port === 'dmz')) {
                            ports.add(port);
                            if (!portUsage[port]) portUsage[port] = { count: 0, contexts: [] };
                            portUsage[port].count++;
                        }
                    });
                });
            });
            
            return {
                raw: text,
                usedPorts: Array.from(ports),
                portUsage,
                addressObjects: Array.from(addresses),
                serviceObjects: Array.from(services),
                addressGroups: Array.from(addrgrps),
                serviceGroups: Array.from(svcgrps)
            };
        }

        function findUnused(parsed) {
            const unused = { addresses: [], services: [], addressGroups: [], serviceGroups: [] };
            const text = parsed.raw;
            
            parsed.addressObjects.forEach(a => {
                const refs = (text.match(new RegExp(`["']${a}["']`, 'g')) || []).length;
                if (refs <= 2) unused.addresses.push(a);
            });
            parsed.serviceObjects.forEach(s => {
                const refs = (text.match(new RegExp(`["']${s}["']`, 'g')) || []).length;
                if (refs <= 2) unused.services.push(s);
            });
            parsed.addressGroups.forEach(g => {
                const refs = (text.match(new RegExp(`["']${g}["']`, 'g')) || []).length;
                if (refs <= 2) unused.addressGroups.push(g);
            });
            parsed.serviceGroups.forEach(g => {
                const refs = (text.match(new RegExp(`["']${g}["']`, 'g')) || []).length;
                if (refs <= 2) unused.serviceGroups.push(g);
            });
            
            return unused;
        }

        function detectHA(config) {
            const ha = { enabled: false, mode: null, priority: null, group: null };
            
            if (config.includes('config system ha')) {
                ha.enabled = true;
                const haMatch = config.match(/set mode\s+([\w-]+)/i);
                if (haMatch) {
                    const mode = haMatch[1].toLowerCase();
                    if (mode.includes('a-p')) ha.mode = 'Active-Passive';
                    else if (mode.includes('a-a')) ha.mode = 'Active-Active';
                    else ha.mode = mode;
                }
                const priorityMatch = config.match(/set priority\s+(\d+)/i);
                if (priorityMatch) ha.priority = priorityMatch[1];
                const groupMatch = config.match(/set group-id\s+(\d+)/i);
                if (groupMatch) ha.group = groupMatch[1];
            }
            return ha;
        }

        function cleanupConfig(config) {
            let cleaned = config;
            let stats = { uuids: 0, snmp: 0, interfaceSelect: 0 };
            
            const uuidMatches = cleaned.match(/set uuid [a-f0-9-]+\n/gi);
            if (uuidMatches) stats.uuids = uuidMatches.length;
            cleaned = cleaned.replace(/set uuid [a-f0-9-]+\n/gi, '');
            
            const snmpMatches = cleaned.match(/set snmp-index \d+\n/gi);
            if (snmpMatches) stats.snmp = snmpMatches.length;
            cleaned = cleaned.replace(/set snmp-index \d+\n/gi, '');
            
            const interfaceMatches = cleaned.match(/set interface-select-method auto\n/gi);
            if (interfaceMatches) stats.interfaceSelect = interfaceMatches.length;
            cleaned = cleaned.replace(/set interface-select-method auto\n/gi, '');
            
            return { cleaned, stats };
        }

        function convertConfig(config, mapping, utf8Fixes) {
            let result = config;
            
            // Apply UTF-8 fixes first
            if (utf8Fixes && utf8Fixes.length > 0) {
                utf8Fixes.forEach(fix => {
                    if (fix.apply) {
                        const regex = new RegExp(`(edit\\s+["']?)${fix.original}(["']?)`, 'g');
                        result = result.replace(regex, `$1${fix.suggested}$2`);
                        const refRegex = new RegExp(`["']${fix.original}["']`, 'g');
                        result = result.replace(refRegex, `"${fix.suggested}"`);
                    }
                });
            }
            
            // Apply UUID & SNMP cleanup
            const cleanResult = cleanupConfig(result);
            result = cleanResult.cleaned;
            
            // Apply port mapping
            Object.entries(mapping).sort(([a], [b]) => b.length - a.length).forEach(([src, tgt]) => {
                if (tgt) {
                    const patterns = [
                        new RegExp(`(set interface\\s+["']?)${src}(["']?)`, 'g'),
                        new RegExp(`(set member\\s+["']?)${src}(["']?)`, 'g'),
                        new RegExp(`(set srcintf\\s+["']?)${src}(["']?)`, 'g'),
                        new RegExp(`(set dstintf\\s+["']?)${src}(["']?)`, 'g'),
                        new RegExp(`(edit\\s+["']?)${src}(["']?)`, 'g'),
                    ];
                    patterns.forEach(p => { result = result.replace(p, `$1${tgt}$2`); });
                }
            });
            return { config: result, cleanupStats: cleanResult.stats };
        }

        function extractSections(config, targetModel) {
            const sections = {
                '000-target-default.conf': FORTIGATE_MODELS[targetModel]?.defaultHeader || '',
                '001-config-system-global.conf': '',
                '002-config-system-interface.conf': '',
                '003-config-firewall-address.conf': '',
                '004-config-firewall-addrgrp.conf': '',
                '005-config-firewall-service-custom.conf': '',
                '006-config-firewall-service-group.conf': '',
                '007-config-vpn-ipsec-phase1.conf': '',
                '008-config-vpn-ipsec-phase2.conf': '',
                '009-config-router-static.conf': '',
                '010-config-firewall-policy.conf': '',
                '999-config-all.conf': config
            };
            
            let section = null, buffer = [];
            config.split('\n').forEach(line => {
                const t = line.trim();
                if (t.startsWith('config system global')) { section = '001-config-system-global.conf'; buffer = [line]; }
                else if (t.startsWith('config system interface')) { section = '002-config-system-interface.conf'; buffer = [line]; }
                else if (t.startsWith('config firewall address')) { section = '003-config-firewall-address.conf'; buffer = [line]; }
                else if (t.startsWith('config firewall addrgrp')) { section = '004-config-firewall-addrgrp.conf'; buffer = [line]; }
                else if (t.startsWith('config firewall service custom')) { section = '005-config-firewall-service-custom.conf'; buffer = [line]; }
                else if (t.startsWith('config firewall service group')) { section = '006-config-firewall-service-group.conf'; buffer = [line]; }
                else if (t.startsWith('config vpn ipsec phase1')) { section = '007-config-vpn-ipsec-phase1.conf'; buffer = [line]; }
                else if (t.startsWith('config vpn ipsec phase2')) { section = '008-config-vpn-ipsec-phase2.conf'; buffer = [line]; }
                else if (t.startsWith('config router static')) { section = '009-config-router-static.conf'; buffer = [line]; }
                else if (t.startsWith('config firewall policy')) { section = '010-config-firewall-policy.conf'; buffer = [line]; }
                else if (t === 'end' && section) {
                    buffer.push(line);
                    sections[section] += buffer.join('\n') + '\n\n';
                    section = null;
                } else if (section) buffer.push(line);
            });
            
            return sections;
        }

        async function createZip(sections, targetModel, sourceModel, unused, utf8Issues, versionCompat, haInfo, cleanupStats) {
            const zip = new JSZip();
            Object.entries(sections).forEach(([name, content]) => { if (content) zip.file(name, content); });
            
            let readme = `FortiPort Converter Pro v3 - Export Package
Migration: ${sourceModel || 'Auto'} ‚Üí ${targetModel}
Date: ${new Date().toISOString()}

Import Order:
1-10: Individual sections (in numeric order)
OR: 999-config-all.conf (complete)

`;

            if (versionCompat) {
                readme += `\n=== VERSION COMPATIBILITY ===\n`;
                readme += `Status: ${versionCompat.message}\n`;
                if (versionCompat.upgradePath) {
                    readme += `Upgrade Path: ${versionCompat.upgradePath.join(' ‚Üí ')}\n`;
                }
                if (versionCompat.warnings.length > 0) {
                    readme += `Warnings:\n${versionCompat.warnings.map(w => `  - ${w}`).join('\n')}\n`;
                }
            }

            if (haInfo && haInfo.enabled) {
                readme += `\n=== HA CLUSTER DETECTED ===\n`;
                readme += `‚ö†Ô∏è  WARNING: Source device is part of HA cluster!\n`;
                readme += `Mode: ${haInfo.mode || 'Unknown'}\n`;
                if (haInfo.priority) readme += `Priority: ${haInfo.priority}\n`;
                if (haInfo.group) readme += `Group ID: ${haInfo.group}\n`;
                readme += `\nBefore Migration:\n`;
                readme += `  1. Remove from cluster: set mode standalone\n`;
                readme += `  2. Backup peer device config\n`;
                readme += `  3. Migrate one device at a time\n`;
                readme += `  4. Reconfigure HA on new devices\n`;
            }

            if (cleanupStats) {
                readme += `\n=== CONFIG CLEANUP ===\n`;
                readme += `‚úÖ Removed ${cleanupStats.uuids} UUID entries\n`;
                readme += `‚úÖ Cleared ${cleanupStats.snmp} SNMP indexes\n`;
                readme += `‚úÖ Cleaned ${cleanupStats.interfaceSelect} interface-select-method entries\n`;
                readme += `Config is ready for import without conflicts.\n`;
            }

            readme += `\nUnused Objects: ${(unused.addresses.length + unused.services.length + unused.addressGroups.length + unused.serviceGroups.length)}
UTF-8 Issues Fixed: ${utf8Issues ? utf8Issues.filter(i => i.apply).length : 0}

See individual reports for details.
Enable CLI debug: diagnose debug cli 8
`;
            
            const unusedReport = `Unused Objects Report
Addresses: ${unused.addresses.join(', ')}
Services: ${unused.services.join(', ')}
AddrGroups: ${unused.addressGroups.join(', ')}
SvcGroups: ${unused.serviceGroups.join(', ')}
`;
            
            let utf8Report = 'UTF-8 Object Name Issues Report\n\n';
            if (utf8Issues && utf8Issues.length > 0) {
                utf8Report += 'Objects with non-UTF8 or special characters:\n\n';
                utf8Issues.forEach(issue => {
                    utf8Report += `Original: ${issue.original}\n`;
                    utf8Report += `Suggested: ${issue.suggested}\n`;
                    utf8Report += `Issue: ${issue.issue}\n`;
                    utf8Report += `Applied: ${issue.apply ? 'YES' : 'NO'}\n\n`;
                });
            } else {
                utf8Report += 'No UTF-8 issues found. All object names are compatible.\n';
            }
            
            const checklistReport = `PRE-MIGRATION CHECKLIST
Generated: ${new Date().toISOString()}

CRITICAL - BACKUP EVERYTHING BEFORE PROCEEDING:

SOURCE DEVICE BACKUP:
‚òê Full configuration backup (execute backup disk full-config)
‚òê Screenshot of working interface status
‚òê Document all IP addresses and routes
‚òê Export SSL VPN certificates (if applicable)
‚òê Backup FortiManager/FortiAnalyzer settings
${haInfo && haInfo.enabled ? '‚òê Document HA peer configuration\n‚òê Remove from HA cluster before migration' : ''}

TARGET DEVICE PREPARATION:
‚òê Factory reset target device
‚òê Install matching FortiOS version (${versionCompat ? versionCompat.message : 'check compatibility'})
‚òê Console cable ready and tested
‚òê Management laptop with TFTP/USB ready
‚òê Test network cables labeled

MIGRATION PROCESS:
‚òê Disconnect source device from production
‚òê Test target device basic connectivity
‚òê Import converted config section by section
‚òê Verify each section before proceeding
‚òê Test critical services (VPN, routing, policies)
‚òê Run diagnose hardware deviceinfo
‚òê Check interface status
‚òê Verify routing table
‚òê Test policy flow (diag debug flow)

POST-MIGRATION VALIDATION:
‚òê All interfaces UP
‚òê All routes present
‚òê VPN tunnels established
‚òê Critical policies working
‚òê Log to FortiManager/FortiAnalyzer
‚òê HA reconfigured (if applicable)
‚òê Performance monitoring enabled

ROLLBACK PLAN:
‚òê Source device kept connected (standby)
‚òê Original config backup accessible
‚òê Rollback procedure documented
‚òê Team informed of maintenance window

EMERGENCY CONTACTS:
- Network Team: _______________
- Security Team: _______________
- Vendor Support: _______________
`;
            
            zip.file('README.txt', readme);
            zip.file('unused-objects-report.txt', unusedReport);
            zip.file('utf8-issues-report.txt', utf8Report);
            zip.file('pre-migration-checklist.txt', checklistReport);
            
            return await zip.generateAsync({ type: 'blob' });
        }

        function App() {
            const [step, setStep] = useState(1);
            const [srcFile, setSrcFile] = useState(null);
            const [tgtFile, setTgtFile] = useState(null);
            const [detectedSrc, setDetectedSrc] = useState(null);
            const [detectedTgt, setDetectedTgt] = useState(null);
            const [parsed, setParsed] = useState(null);
            const [mapping, setMapping] = useState({});
            const [converted, setConverted] = useState('');
            const [unused, setUnused] = useState(null);
            const [utf8Issues, setUtf8Issues] = useState([]);
            const [versionCompat, setVersionCompat] = useState(null);
            const [haInfo, setHaInfo] = useState(null);
            const [cleanupStats, setCleanupStats] = useState(null);
            const [tab, setTab] = useState('converted');
            const [targetModel, setTargetModel] = useState('');
            const [srcDragging, setSrcDragging] = useState(false);
            const [tgtDragging, setTgtDragging] = useState(false);
            
            const handleSrcUpload = (file) => {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const det = detectConfigType(text);
                    setDetectedSrc(det);
                    if (det.vendor === 'FortiGate') {
                        const p = parseConfig(text);
                        setParsed(p);
                        const m = {};
                        p.usedPorts.forEach(port => { m[port] = ''; });
                        setMapping(m);
                        setUnused(findUnused(p));
                        
                        // Check UTF-8 issues
                        const utf8Probs = validateUTF8Objects(p);
                        setUtf8Issues(utf8Probs.map(issue => ({ ...issue, apply: true })));
                        
                        // Detect HA configuration
                        const ha = detectHA(text);
                        setHaInfo(ha);
                    }
                };
                reader.readAsText(file);
                setSrcFile(file);
            };
            
            const handleTgtUpload = (file) => {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const det = detectConfigType(e.target.result);
                    setDetectedTgt(det);
                    if (det.model) {
                        setTargetModel(det.model);
                        // Check version compatibility
                        if (detectedSrc && detectedSrc.version) {
                            const compat = checkVersionCompatibility(detectedSrc.model, detectedSrc.version, det.model);
                            setVersionCompat(compat);
                        }
                    }
                };
                reader.readAsText(file);
                setTgtFile(file);
            };
            
            const handleTargetModelChange = (model) => {
                setTargetModel(model);
                if (detectedSrc && detectedSrc.version) {
                    const compat = checkVersionCompatibility(detectedSrc.model, detectedSrc.version, model);
                    setVersionCompat(compat);
                }
            };
            
            const handleConvert = () => {
                const result = convertConfig(parsed.raw, mapping, utf8Issues);
                setConverted(result.config);
                setCleanupStats(result.cleanupStats);
                setStep(3);
            };
            
            const handleDownloadZip = async () => {
                const tm = targetModel || detectedTgt?.model;
                const sections = extractSections(converted, tm);
                const blob = await createZip(sections, tm, detectedSrc?.model, unused, utf8Issues, versionCompat, haInfo, cleanupStats);
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fortigate-migration-${Date.now()}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };
            
            const allMapped = parsed && Object.values(mapping).every(v => v);
            const totalUnused = unused ? unused.addresses.length + unused.services.length + unused.addressGroups.length + unused.serviceGroups.length : 0;
            
            return (
                <div className="app-container">
                    <div className="bg-gradient"></div>
                    <header className="header">
                        <div className="header-content">
                            <div className="logo-section">
                                <svg className="logo-svg" viewBox="0 0 566.93 141.73" xmlns="http://www.w3.org/2000/svg">
                                    <path fill="#f1572b" d="M109.82,96.59l-13.55,13.55c-2.92,2.92-2.92,7.65,0,10.57,1.46,1.46,3.37,2.19,5.28,2.19s3.83-.73,5.28-2.19l13.55-13.55c2.92-2.92,2.92-7.65,0-10.57-2.92-2.92-7.65-2.92-10.57,0Z"/>
                                    <path fill="#f1572b" d="M25.72,46.79c1.91,0,3.83-.73,5.28-2.19l13.41-13.41c2.92-2.92,2.92-7.65,0-10.57-2.92-2.92-7.65-2.92-10.57,0l-13.41,13.41c-2.92,2.92-2.92,7.65,0,10.57,1.46,1.46,3.37,2.19,5.29,2.19Z"/>
                                    <path fill="#f1572b" d="M25.7,84.68c1.91,0,3.83-.73,5.28-2.19l51.4-51.4c2.92-2.92,2.92-7.65,0-10.57-2.92-2.92-7.65-2.92-10.57,0l-51.4,51.4c-2.92,2.92-2.92,7.65,0,10.57,1.46,1.46,3.37,2.19,5.28,2.19Z"/>
                                    <path fill="#f1572b" d="M120.38,59c-2.92-2.92-7.65-2.92-10.57,0l-51.16,51.16c-2.92,2.92-2.92,7.65,0,10.57,1.46,1.46,3.37,2.19,5.28,2.19s3.83-.73,5.28-2.19l51.16-51.16c2.92-2.92,2.92-7.65,0-10.57Z"/>
                                    <path fill="#f1572b" d="M120.44,20.73c-2.92-2.92-7.65-2.92-10.57,0L20.42,110.18c-2.92,2.92-2.92,7.65,0,10.57,1.46,1.46,3.37,2.19,5.28,2.19s3.83-.73,5.28-2.19L120.44,31.3c2.92-2.92,2.92-7.65,0-10.57Z"/>
                                    <path fill="#fff" d="M166.25,37.12c-1.26-1.26-2.1-3.08-2.1-4.9s.84-3.64,2.1-4.9c1.26-1.26,3.08-2.1,4.9-2.1s3.64.84,4.9,2.1c1.26,1.26,1.96,3.08,1.96,4.9s-.7,3.64-1.96,4.9c-1.26,1.26-3.08,1.96-4.9,1.96s-3.64-.7-4.9-1.96Z"/>
                                    <path fill="#fff" d="M164.15,116.4v-56.45c0-3.78,3.08-6.86,7-6.86s6.86,3.08,6.86,6.86v56.45c0,3.92-3.08,7-6.86,7s-7-3.08-7-7Z"/>
                                    <path fill="#fff" d="M256.3,88.1v28.15c0,3.92-3.08,7-7,7s-6.86-3.08-6.86-7v-28.15c0-11.77-9.53-21.29-21.29-21.29s-21.29,9.52-21.29,21.29v28.15c0,3.92-3.08,7-7,7s-6.87-3.08-6.87-7v-28.15c0-19.47,15.83-35.15,35.15-35.15s35.15,15.69,35.15,35.15Z"/>
                                    <path fill="#fff" d="M303.64,59.81c0,3.92-3.08,7-7,7h-12.32v49.44c0,3.92-3.08,7-7,7s-6.86-3.08-6.86-7v-49.44h-7.7c-3.78,0-6.86-3.08-6.86-7s3.08-6.86,6.86-6.86h7.7c-.14-9.94,3.5-19.05,10.23-25.77,3.78-3.78,8.12-6.58,13.17-8.26,3.5-1.4,7.56.56,8.82,4.2,1.26,3.5-.56,7.56-4.2,8.82-2.94.98-5.6,2.66-7.98,5.04-4.2,4.2-6.16,9.66-6.16,15.97h12.32c3.92,0,7,3.08,7,6.86Z"/>
                                    <path fill="#fff" d="M345.23,59.95c0,3.78-3.08,7-7,7-11.76,0-21.29,9.52-21.29,21.29v28.15c0,3.78-3.08,7-6.86,7s-7-3.22-7-7v-28.15c0-19.47,15.83-35.15,35.15-35.15,3.92,0,7,3.08,7,6.86Z"/>
                                    <path fill="#fff" d="M414.27,88.66v27.45c0,4.06-2.94,7-7,7-2.8,0-6.72-2.94-6.72-7-6.02,5.04-12.75,7-20.73,7-19.75,0-35.43-14.71-35.43-34.45s15.68-35.44,35.43-35.44,34.45,15.69,34.45,35.44ZM400.55,88.66c0-11.77-8.96-21.71-20.73-21.71s-21.71,9.94-21.71,21.71,9.94,20.73,21.71,20.73,20.73-8.96,20.73-20.73Z"/>
                                    <path fill="#fff" d="M422.39,116.4V25.22c0-3.78,3.08-6.86,7-6.86s6.86,3.08,6.86,6.86v91.18c0,3.92-3.08,7-6.86,7s-7-3.08-7-7Z"/>
                                    <path fill="#fff" d="M447.04,37.12c-1.26-1.26-2.1-3.08-2.1-4.9s.84-3.64,2.1-4.9c1.26-1.26,3.08-2.1,4.9-2.1s3.64.84,4.9,2.1c1.26,1.26,1.96,3.08,1.96,4.9s-.7,3.64-1.96,4.9c-1.26,1.26-3.08,1.96-4.9,1.96s-3.64-.7-4.9-1.96Z"/>
                                    <path fill="#fff" d="M444.94,116.4v-56.45c0-3.78,3.08-6.86,7-6.86s6.86,3.08,6.86,6.86v56.45c0,3.92-3.08,7-6.86,7s-7-3.08-7-7Z"/>
                                    <path fill="#f1572b" d="M513.63,76.76l9.73-12.61c2.38-3.08,1.82-7.42-1.26-9.8-2.94-2.38-7.28-1.82-9.66,1.26l-7.88,10.17,9.07,10.98Z"/>
                                    <path fill="#fff" d="M505.17,88.49l-.02.03-10-12.92h0l-15.49-19.99c-2.38-3.08-6.72-3.64-9.66-1.26-3.08,2.38-3.64,6.72-1.26,9.8l18.49,23.95-18.49,23.95c-2.38,3.08-1.82,7.42,1.26,9.66,1.26.98,2.66,1.54,4.20,1.54,2.1,0,4.06-.98,5.46-2.66l16.38-21.15,16.39,21.15c1.4,1.68,3.36,2.66,5.46,2.66,1.54,0,2.94-.56,4.20-1.54,3.08-2.24,3.64-6.58,1.26-9.66l-18.19-23.57Z"/>
                                </svg>
                                <div className="divider"></div>
                                <div className="tool-name">FortiPort Converter</div>
                                <span className="pro-badge">PRO v3</span>
                            </div>
                        </div>
                    </header>
                    <main className="main-content">
                        <div className="step-indicator">
                            {[{n:1,l:'Upload & Validate'},{n:2,l:'Port Mapping'},{n:3,l:'Export'}].map(s => (
                                <div key={s.n} className={`step ${step===s.n?'active':''} ${step>s.n?'completed':''}`}>
                                    <div className="step-number">{s.n}</div>
                                    <div className="step-label">{s.l}</div>
                                </div>
                            ))}
                        </div>
                        
                        {step === 1 && (
                            <>
                                <div className="card">
                                    <h2 className="card-title">üì§ Upload Source Config</h2>
                                    <p className="card-description">Auto-detects FortiGate model and version. Validates UTF-8 object names.</p>
                                    <div 
                                        className={`file-upload-area ${srcDragging ? 'dragging' : ''}`}
                                        onClick={() => document.getElementById('src').click()}
                                        onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); }}
                                        onDragEnter={(e) => { e.preventDefault(); e.stopPropagation(); setSrcDragging(true); }}
                                        onDragLeave={(e) => { e.preventDefault(); e.stopPropagation(); setSrcDragging(false); }}
                                        onDrop={(e) => { 
                                            e.preventDefault(); 
                                            e.stopPropagation();
                                            setSrcDragging(false);
                                            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                                                handleSrcUpload(e.dataTransfer.files[0]);
                                            }
                                        }}
                                    >
                                        <div className="upload-icon">üìÑ</div>
                                        <div className="upload-text">{srcFile ? 'Uploaded!' : 'Click or drag source config'}</div>
                                        <input id="src" type="file" style={{display:'none'}} onChange={(e) => handleSrcUpload(e.target.files[0])} />
                                    </div>
                                    {srcFile && detectedSrc?.detected && (
                                        <div className="file-info">
                                            <span className="file-name">{srcFile.name}</span>
                                            <span className="file-detected-badge">
                                                {detectedSrc.vendor} {detectedSrc.model} v{detectedSrc.version}
                                            </span>
                                            <span className="file-size">{(srcFile.size/1024).toFixed(2)} KB</span>
                                        </div>
                                    )}
                                    
                                    {haInfo && haInfo.enabled && (
                                        <div className="alert alert-warning">
                                            <span>‚ö†Ô∏è</span>
                                            <div>
                                                <strong>HA CLUSTER DETECTED!</strong>
                                                <div style={{marginTop:'0.5rem'}}>
                                                    Mode: {haInfo.mode || 'Unknown'}<br/>
                                                    {haInfo.priority && `Priority: ${haInfo.priority}`}<br/>
                                                    {haInfo.group && `Group ID: ${haInfo.group}`}
                                                </div>
                                                <div style={{marginTop:'0.5rem',fontSize:'0.9rem'}}>
                                                    <strong>Before Migration:</strong>
                                                    <ul style={{marginLeft:'1.5rem',marginTop:'0.3rem'}}>
                                                        <li>Remove from cluster: <code>set mode standalone</code></li>
                                                        <li>Backup peer device configuration</li>
                                                        <li>Migrate one device at a time</li>
                                                        <li>Reconfigure HA on new devices after migration</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {utf8Issues && utf8Issues.length > 0 && (
                                        <div className="utf8-issues-section">
                                            <h3 style={{marginBottom:'1rem',color:'var(--error)'}}>‚ö†Ô∏è UTF-8 Object Name Issues Detected</h3>
                                            <p style={{marginBottom:'1rem',fontSize:'0.9rem'}}>
                                                Found {utf8Issues.length} objects with non-UTF8 characters (Turkish, Arabic, Chinese, etc.). 
                                                These will cause import failures on newer FortiOS versions.
                                            </p>
                                            <table className="object-rename-table">
                                                <thead>
                                                    <tr>
                                                        <th>Original Name</th>
                                                        <th>Suggested Name</th>
                                                        <th>Issue</th>
                                                        <th>Apply Fix</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {utf8Issues.slice(0, 10).map((issue, idx) => (
                                                        <tr key={idx}>
                                                            <td>{issue.original}</td>
                                                            <td style={{color:'var(--success)'}}>{issue.suggested}</td>
                                                            <td>{issue.issue}</td>
                                                            <td>
                                                                <input 
                                                                    type="checkbox" 
                                                                    checked={issue.apply}
                                                                    onChange={(e) => {
                                                                        const newIssues = [...utf8Issues];
                                                                        newIssues[idx].apply = e.target.checked;
                                                                        setUtf8Issues(newIssues);
                                                                    }}
                                                                />
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                            {utf8Issues.length > 10 && (
                                                <p style={{marginTop:'0.5rem',fontSize:'0.85rem',color:'var(--text-muted)'}}>
                                                    ... and {utf8Issues.length - 10} more. Full list in export report.
                                                </p>
                                            )}
                                        </div>
                                    )}
                                </div>
                                
                                <div className="card">
                                    <h2 className="card-title">üéØ Upload Target Config (Optional)</h2>
                                    <p className="card-description">Upload target FortiGate default config to preserve headers and check version compatibility.</p>
                                    <div 
                                        className={`file-upload-area ${tgtDragging ? 'dragging' : ''}`}
                                        onClick={() => document.getElementById('tgt').click()}
                                        onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); }}
                                        onDragEnter={(e) => { e.preventDefault(); e.stopPropagation(); setTgtDragging(true); }}
                                        onDragLeave={(e) => { e.preventDefault(); e.stopPropagation(); setTgtDragging(false); }}
                                        onDrop={(e) => { 
                                            e.preventDefault(); 
                                            e.stopPropagation();
                                            setTgtDragging(false);
                                            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                                                handleTgtUpload(e.dataTransfer.files[0]);
                                            }
                                        }}
                                    >
                                        <div className="upload-icon">üéØ</div>
                                        <div className="upload-text">{tgtFile ? 'Uploaded!' : 'Click or drag target config'}</div>
                                        <input id="tgt" type="file" style={{display:'none'}} onChange={(e) => handleTgtUpload(e.target.files[0])} />
                                    </div>
                                    {tgtFile && detectedTgt && (
                                        <div className="file-info">
                                            <span className="file-name">{tgtFile.name}</span>
                                            <span className="file-detected-badge">
                                                {detectedTgt.vendor} {detectedTgt.model} v{detectedTgt.version}
                                            </span>
                                        </div>
                                    )}
                                    {!tgtFile && (
                                        <>
                                            <div style={{margin:'2rem 0',textAlign:'center',color:'var(--text-muted)'}}>- OR -</div>
                                            <div className="select-wrapper">
                                                <select value={targetModel} onChange={(e) => handleTargetModelChange(e.target.value)}>
                                                    <option value="">Select target model...</option>
                                                    {Object.keys(FORTIGATE_MODELS).map(m => (
                                                        <option key={m} value={m}>
                                                            FortiGate {m} ({FORTIGATE_MODELS[m].ports.length} ports) - Max: {FORTIGATE_MODELS[m].maxVersion}
                                                        </option>
                                                    ))}
                                                </select>
                                            </div>
                                        </>
                                    )}
                                    
                                    {versionCompat && (
                                        <div className="version-compat-section">
                                            <h3 style={{marginBottom:'1rem',color:'var(--info)'}}>üìä Version Compatibility Check</h3>
                                            <div className={`alert ${versionCompat.canDowngrade ? 'alert-success' : 'alert-error'}`}>
                                                <span>{versionCompat.canDowngrade ? '‚úÖ' : '‚ùå'}</span>
                                                <div>
                                                    <strong>{versionCompat.message}</strong>
                                                    {versionCompat.warnings.length > 0 && (
                                                        <ul style={{marginTop:'0.5rem',marginLeft:'1.5rem'}}>
                                                            {versionCompat.warnings.map((w, i) => <li key={i}>{w}</li>)}
                                                        </ul>
                                                    )}
                                                </div>
                                            </div>
                                            
                                            {versionCompat.upgradePath && (
                                                <div className="upgrade-path">
                                                    <strong>Recommended Upgrade Path:</strong>
                                                    <div style={{marginTop:'0.5rem',color:'var(--success)'}}>
                                                        {versionCompat.upgradePath.join(' ‚Üí ')}
                                                    </div>
                                                    <div style={{marginTop:'0.5rem',fontSize:'0.85rem',color:'var(--text-muted)'}}>
                                                        ‚ö†Ô∏è Critical: Must upgrade through each version to avoid configuration loss
                                                    </div>
                                                </div>
                                            )}
                                            
                                            <div style={{marginTop:'1rem',padding:'1rem',background:'var(--darker-bg)',borderRadius:'8px',fontSize:'0.85rem'}}>
                                                <strong>Migration Strategy:</strong>
                                                <ol style={{marginTop:'0.5rem',marginLeft:'1.5rem'}}>
                                                    <li>Match source version on target device first</li>
                                                    <li>Restore converted config</li>
                                                    <li>Follow upgrade path to recommended version</li>
                                                    <li>Recommended: {FORTIGATE_MODELS[targetModel]?.recommendedVersion}</li>
                                                </ol>
                                            </div>
                                        </div>
                                    )}
                                </div>
                                
                                <div className="button-group">
                                    <button className="btn btn-primary" disabled={!srcFile || !detectedSrc || (!tgtFile && !targetModel)} onClick={() => setStep(2)}>
                                        Next: Port Mapping ‚Üí
                                    </button>
                                </div>
                            </>
                        )}
                        
                        {step === 2 && parsed && (
                            <div className="card">
                                <h2 className="card-title">üîÑ Port Mapping</h2>
                                <div className="stats-grid">
                                    <div className="stat-card"><div className="stat-value">{parsed.usedPorts.length}</div><div className="stat-label">Ports</div></div>
                                    <div className="stat-card"><div className="stat-value">{Object.values(mapping).filter(v=>v).length}</div><div className="stat-label">Mapped</div></div>
                                    <div className="stat-card"><div className="stat-value">{parsed.addressObjects.length}</div><div className="stat-label">Addresses</div></div>
                                    <div className="stat-card"><div className="stat-value" style={{color:totalUnused>0?'var(--warning)':'var(--success)'}}>{totalUnused}</div><div className="stat-label">Unused</div></div>
                                    <div className="stat-card"><div className="stat-value" style={{color:utf8Issues.length>0?'var(--error)':'var(--success)'}}>{utf8Issues.filter(i=>i.apply).length}</div><div className="stat-label">UTF-8 Fixes</div></div>
                                </div>
                                {totalUnused > 0 && (
                                    <div className="alert alert-warning">
                                        <span>‚ö†Ô∏è</span>
                                        <div><strong>Unused Objects</strong><div>{totalUnused} objects not referenced. See export report.</div></div>
                                    </div>
                                )}
                                <table className="mapping-table">
                                    <thead><tr><th>Source Port</th><th>Usage</th><th>Target Port</th></tr></thead>
                                    <tbody>
                                        {parsed.usedPorts.map(port => (
                                            <tr key={port}>
                                                <td><span className="port-badge">{port}</span></td>
                                                <td><span className="usage-badge">{parsed.portUsage[port]?.count || 0} refs</span></td>
                                                <td>
                                                    <div className="select-wrapper">
                                                        <select value={mapping[port]||''} onChange={(e) => setMapping({...mapping, [port]:e.target.value})}>
                                                            <option value="">Select...</option>
                                                            {FORTIGATE_MODELS[targetModel||detectedTgt?.model]?.ports.map(p => (
                                                                <option key={p} value={p}>{p}</option>
                                                            ))}
                                                        </select>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                <div className="button-group">
                                    <button className="btn btn-secondary" onClick={() => setStep(1)}>‚Üê Back</button>
                                    <button className="btn btn-primary" disabled={!allMapped} onClick={handleConvert}>Convert ‚Üí</button>
                                </div>
                            </div>
                        )}
                        
                        {step === 3 && (
                            <div className="card">
                                <h2 className="card-title">‚úÖ Complete!</h2>
                                <div className="stats-grid">
                                    <div className="stat-card"><div className="stat-value">‚úì</div><div className="stat-label">Success</div></div>
                                    <div className="stat-card"><div className="stat-value">{Object.keys(mapping).length}</div><div className="stat-label">Ports Remapped</div></div>
                                    {cleanupStats && <div className="stat-card"><div className="stat-value">{cleanupStats.uuids + cleanupStats.snmp}</div><div className="stat-label">Items Cleaned</div></div>}
                                    <div className="stat-card"><div className="stat-value">13</div><div className="stat-label">Files in ZIP</div></div>
                                    <div className="stat-card"><div className="stat-value">{(new Blob([converted]).size/1024).toFixed(2)} KB</div><div className="stat-label">Config Size</div></div>
                                </div>
                                {cleanupStats && (cleanupStats.uuids > 0 || cleanupStats.snmp > 0) && (
                                    <div className="alert alert-success">
                                        <span>üßπ</span>
                                        <div>
                                            <strong>Config Cleanup Applied:</strong>
                                            <div style={{marginTop:'0.5rem',fontSize:'0.9rem'}}>
                                                Removed {cleanupStats.uuids} UUID entries, {cleanupStats.snmp} SNMP indexes, and {cleanupStats.interfaceSelect} interface-select entries. 
                                                Config is ready for import without conflicts.
                                            </div>
                                        </div>
                                    </div>
                                )}
                                <div className="alert alert-success">
                                    <span>üì¶</span>
                                    <div><strong>Export Package Includes:</strong><ul style={{marginTop:'0.5rem',marginLeft:'1.5rem'}}>
                                        <li>12 sectioned config files</li>
                                        <li>Complete config-all.conf</li>
                                        <li>Pre-migration checklist</li>
                                        <li>Unused objects report</li>
                                        <li>UTF-8 issues report with fixes</li>
                                        <li>Version compatibility analysis</li>
                                        {haInfo && haInfo.enabled && <li>HA cluster migration guide</li>}
                                        <li>README with complete migration strategy</li>
                                    </ul></div>
                                </div>
                                <div className="tab-container">
                                    <button className={`tab ${tab==='converted'?'active':''}`} onClick={() => setTab('converted')}>Preview</button>
                                    <button className={`tab ${tab==='changes'?'active':''}`} onClick={() => setTab('changes')}>Changes</button>
                                </div>
                                {tab === 'converted' && (
                                    <div className="config-preview">
                                        {converted.split('\n').slice(0,50).map((line,i) => (
                                            <div key={i} className={`config-line ${Object.values(mapping).some(t=>t&&line.includes(t))?'changed':''}`}>{line}</div>
                                        ))}
                                    </div>
                                )}
                                {tab === 'changes' && (
                                    <div className="config-preview">
                                        {Object.entries(mapping).map(([s,t]) => (
                                            <div key={s} className="config-line changed">
                                                <span className="port-badge">{s}</span> ‚Üí <span className="port-badge">{t}</span>
                                                <span style={{marginLeft:'2rem',color:'var(--text-muted)'}}>({parsed.portUsage[s]?.count||0} refs)</span>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                <div className="button-group">
                                    <button className="btn btn-secondary" onClick={() => window.location.reload()}>New Conversion</button>
                                    <button className="btn btn-primary" onClick={handleDownloadZip}>üì¶ Download Complete Package</button>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
